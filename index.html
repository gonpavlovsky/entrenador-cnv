<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rafa Entrenador CNV</title>
<style>
  :root{
    --bg:#0b1020; --panel:#121833; --muted:#9aa4bf; --text:#eaf0ff; --accent:#7bdcf5; --good:#38d39f; --bad:#ff7b7b;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#0b1020,#090d1a 40%,#0b1020); color:var(--text); min-height:100vh;}
  header{display:flex; gap:12px; align-items:center; padding:16px 20px; position:sticky; top:0; background:#0b1020e6; backdrop-filter:blur(6px); border-bottom:1px solid #1f2747; z-index: 10;}
  header h1{font-size:18px; margin:0; letter-spacing:.3px}
  .caps{padding:6px 10px; background:#0d1430; border:1px solid #1f2747; border-radius:10px; color:var(--muted); font-size:12px}
  main{max-width:980px; margin:22px auto; padding:0 16px 40px 16px}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tab{cursor:pointer; padding:10px 14px; border-radius:999px; background:#0e1533; border:1px solid #1f2747; color:var(--muted); user-select:none; transition: all .15s ease;}
  .tab:hover{background:var(--panel); border-color:#2a3460}
  .tab.active{background:var(--accent); color:#0b1020; border-color:var(--accent); font-weight:600;}
  section{display:none; margin-top:16px; background:var(--panel); border:1px solid #1f2747; border-radius:16px; padding:18px}
  section.active{display:block}
  textarea,input,select,button{font:inherit}
  textarea{width:100%; min-height:180px; background:#0e1430; color:var(--text); border:1px solid #2a3460; border-radius:12px; padding:12px; resize:vertical}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .pill{padding:8px 12px; border-radius:999px; border:1px solid #2a3460; background:#0e1533; color:var(--text)}
  .btn{cursor:pointer; padding:10px 14px; border-radius:12px; background:#0e88ff; border:none; color:white; font-weight:600; box-shadow:0 8px 20px #0e88ff33; transition: all .15s ease;}
  .btn:hover{filter:brightness(1.2)}
  .btn:active{transform:scale(.97)}
  .btn.secondary{background:#23305e; box-shadow:none}
  .btn.ghost{background:transparent; border:1px solid #2a3460; color:var(--muted)}
  .btn.good{background:var(--good); color:#0b1020; box-shadow:0 8px 20px #38d39f33} .btn.bad{background:var(--bad); color:#0b1020; box-shadow:0 8px 20px #ff7b7b33}
  .grid{display:grid; gap:14px}
  .two{grid-template-columns:1fr 1fr}
  .card{background:#0e1430; border:1px solid #2a3460; border-radius:14px; padding:14px}
  .q{font-size:20px; line-height:1.35; color:var(--accent);}
  .a{margin-top:10px; padding:10px 12px; border-radius:10px; background:#0b112b; border:1px dashed #32407a}
  .muted{color:var(--muted); font-size:13px}
  .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{font-size:12px; padding:6px 10px; border-radius:999px; background:#0b112b; border:1px solid #293668; color:#cfe1ff}
  .stats{display:flex; gap:16px; flex-wrap:wrap}
  .stat{padding:10px 12px; border-radius:12px; background:#0b112b; border:1px solid #293668}
  .hidden{display:none}
  .opt{display:block;margin:6px 0;padding:10px 12px;border-radius:10px;border:1px solid #2a3460;background:#0b112b}
  .btn.opt{display:block;width:100%;text-align:left;margin:6px 0; background:#0e1533; border:1px solid #2a3460; box-shadow:none; color:var(--text)}
  .btn.opt:hover{background:var(--panel); border:1px solid var(--accent)}
  .btn.opt:disabled{background:var(--panel); border-color:#2a3460; opacity: 0.8;}
  input[type="file"]{font-size:12px; background:#0b112b; border-color:#293668; color:var(--muted);}
  
  @media(max-width: 600px){
    .two{grid-template-columns:1fr}
    .tabs{justify-content:center}
    header h1{font-size:16px;}
    .row{justify-content:center;}
  }
</style>
</head>
<body>
  <header>
    <h1>Rafa Entrenador CNV</h1>
    <span class="caps">archivo √∫nico ‚Äì offline</span>
  </header>
  <main>
    <div class="tabs">
      <div class="tab active" data-tab="preguntas">Preguntas</div>
      <div class="tab" data-tab="entrenar">Entrenar</div>
      <div class="tab" data-tab="examen">Examen (Multiple Choice)</div>
      <div class="tab" data-tab="quiz">Quiz R√°pido</div>
      <div class="tab" data-tab="estadisticas">Estad√≠sticas</div>
    </div>

    <section id="preguntas" class="active">
      <div class="grid two">
        <div class="card">
          <h3 style="margin-top:0">Cargar banco de Preguntas</h3>
          <p class="muted">Este modo de carga manual **no** soporta opciones incorrectas. Para eso, modific√° y carg√° el archivo JSON.</p>
          <textarea id="bulk" placeholder="Pregunta 1 | Respuesta 1&#10;Pregunta 2 | Respuesta 2..."></textarea>
          <div class="row" style="margin-top:10px; gap:8px;">
            <button class="btn" id="parse">Agregar (modo simple)</button>
            <button class="btn ghost" id="clear">Vaciar todo</button>
          </div>
           <hr style="border-color:#1f2747; margin: 16px 0 12px;">
           <p class="muted" style="margin:0 0 8px 0">Carga por archivo (para el caso de que la carga autom√°tica haya fallado).</p>
           <div class="row" style="gap:8px;">
            <label class="pill" title="Cargar banco_preguntas.json">Preguntas (JSON Nuevo)
              <input type="file" id="importFile" accept="application/json" style="margin-left:8px;" />
            </label>
          </div>
           <p id="autoLoadStatus" class="muted" style="margin-top:16px;"></p>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Resumen</h3>
          <div class="stats">
            <div class="stat">Tarjetas: <b id="count">0</b></div>
            <div class="stat">Repasos hoy: <b id="today">0</b></div>
            <div class="stat">Aciertos: <b id="hits">0</b></div>
            <div class="stat">Errores: <b id="miss">0</b></div>
          </div>
          <p class="muted" style="margin-top:10px">Los datos se guardan S√ìLO en este navegador. Us√° Backup para mover tu progreso.</p>
          <div id="preview" class="chips" style="margin-top:10px"></div>
        </div>
      </div>
    </section>

    <section id="entrenar">
      <div class="row" style="justify-content:space-between">
        <div class="chips">
          <span class="chip">Aleatorio ponderado (SRS light)</span>
          <span class="chip">Mostrar respuesta con clic</span>
        </div>
        <div class="chips">
          <button class="btn secondary" id="skip">Saltar</button>
          <button class="btn ghost" id="resetSRS">Reiniciar pesos</button>
        </div>
      </div>
      <div class="card" style="margin-top:12px; cursor:pointer;" id="flashcard">
        <div class="q" id="qText">Carg√° preguntas en la pesta√±a ‚ÄúPreguntas‚Äù üôÇ</div>
        <div class="a hidden" id="aBox">
          <div id="aText"></div>
          <div class="row" style="margin-top:10px; justify-content:flex-end;">
            <button class="btn good" id="good">¬°Bien!</button>
            <button class="btn bad" id="again">M√°s pr√°ctica</button>
          </div>
        </div>
      </div>
    </section>

    <section id="examen">
      <div class="row">
        <label class="pill"># de preguntas
          <select id="examCount" style="margin-left:8px; background:transparent; border:none; color:var(--text)">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
        </label>
        <label class="pill">Opciones por pregunta
          <select id="optCount" style="margin-left:8px; background:transparent; border:none; color:var(--text)">
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
          </select>
        </label>
        <button class="btn" id="startExam">Iniciar Examen</button>
      </div>
      <p class="muted" style="margin:8px 0 0">Las opciones incorrectas se toman del archivo JSON de preguntas.</p>
      <div id="examBox" class="hidden" style="margin-top:12px; background:transparent; border:none; padding:0;"></div>
      <div id="examResult" class="card hidden" style="margin-top:12px"></div>
    </section>

    <section id="quiz">
      <div class="row">
        <button class="btn" id="startQuick">Comenzar Quiz (1 min)</button>
        <div id="quickTimer" class="pill hidden" style="font-size: 1.1em; color:var(--accent); min-width:60px; text-align:center;">01:00</div>
        <div class="pill">Puntaje: <b id="quickScore">0</b></div>
      </div>
      <div id="quickBox" class="card" style="margin-top:12px">
        <div class="muted">Se te har√°n preguntas al azar una por vez. ¬°Responde lo m√°s r√°pido posible!</div>
      </div>
    </section>

    <section id="estadisticas">
      <div class="grid two">
        <div class="card">
          <h3 style="margin-top:0">Progreso</h3>
          <p class="muted">Historial simple de aciertos/errores y sesiones de examen.</p>
          <div id="log" class="mono" style="white-space:pre-wrap; font-size:12px; max-height: 200px; overflow-y:auto; background:#0b112b; padding: 8px; border-radius: 8px;"></div>
        </div>
        <div class="card">
          <h3 style="margin-top:0">Backup (Importante)</h3>
          <p class="muted">El banco de preguntas y tu progreso se guardan S√ìLO en este navegador. Export√° un backup para no perderlo o moverlo a otra compu.</p>
          <div class="row">
            <button class="btn secondary" id="backup">Exportar todo (.json)</button>
            <label class="pill" title="Restaurar backup">Restaurar
              <input type="file" id="restore" accept="application/json" style="margin-left:8px;" />
            </label>
          </div>
          <hr style="border-color:#1f2747; margin: 16px 0 12px;">
          <h3 style="margin-top:0">Resetear</h3>
          <p class="muted">Esto borra solo el historial de ex√°menes. No borra las preguntas.</p>
          <button class="btn bad" id="resetExamStats">Resetear Estad√≠sticas Examen</button>
        </div>
      </div>
    </section>
  </main>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // --- UI helpers ---
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];
  
  const LS_KEY = 'rafa_cnv_cards_v2_mc'; // Cambi√© la versi√≥n de la key
  const STATS_KEY = 'rafa_cnv_stats_v2_mc';
  const SESS_KEY = 'rafa_cnv_sessions_v2_mc';
  // Ya no necesitamos DIST_KEY

  let cards = load(LS_KEY, []);
  let stats = load(STATS_KEY, {hits:0, miss:0, today:0, lastReset: new Date().toDateString()});
  let sessions = load(SESS_KEY, []);
  let current = null; // index
  
  // Resetea "repasos hoy" si es un nuevo d√≠a
  if(stats.lastReset !== new Date().toDateString()){
    stats.today = 0;
    stats.lastReset = new Date().toDateString();
    save(STATS_KEY, stats);
  }

  // --- L√ìGICA DE CARGA AUTOM√ÅTICA ---
  const autoLoadStatus = $('#autoLoadStatus');

  async function tryLoadFromURL() {
      // Si ya hay tarjetas, no hacer nada
      if (cards.length > 0) {
          autoLoadStatus.innerHTML = `<span style="color:var(--good)">&#10003; Datos ya cargados en el navegador.</span>`;
          renderBank();
          pick();
          return;
      }
      
      autoLoadStatus.innerHTML = 'Intentando carga autom√°tica de `banco_preguntas.json`...';
      
      try {
          const response = await fetch(`banco_preguntas.json?t=${new Date().getTime()}`);
          if (response.ok) {
              const data = await response.json();
              if (Array.isArray(data) && data.length > 0) {
                  cards = data;
                  save(LS_KEY, cards); // Guardar en localStorage
                  autoLoadStatus.innerHTML = `<span style="color:var(--good)">&#10003; Carga autom√°tica de ${cards.length} preguntas exitosa.</span>`;
              } else {
                  throw new Error("El JSON est√° vac√≠o o no es un array.");
              }
          } else {
              throw new Error(`Error ${response.status}: No se encontr√≥ el archivo.`);
          }
      } catch (error) {
          console.warn(`No se pudo cargar 'banco_preguntas.json'.`, error);
          autoLoadStatus.innerHTML = `<span style="color:var(--bad)">&#10007; 'banco_preguntas.json' no encontrado. Us√° la carga manual.</span>`;
      }

      // Volver a renderizar despu√©s de la carga
      renderBank();
      pick();
  }
  
  // Iniciar la carga al cargar la p√°gina
  tryLoadFromURL();


  // --- Tabs ---
  $$('.tab').forEach(t=>t.addEventListener('click',()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id = t.dataset.tab; 
    $$('section').forEach(s=>s.classList.remove('active'));
    $('#'+id).classList.add('active');
  }));

  // --- BANCO ---
  function renderBank(){
    $('#count').textContent = cards.length; 
    $('#hits').textContent = stats.hits; 
    $('#miss').textContent = stats.miss; 
    $('#today').textContent = stats.today;
    
    // Ya no mostramos distractores
    const distractorStat = $('#distCount');
    if(distractorStat) distractorStat.closest('.stat').style.display = 'none';

    const prev = $('#preview'); prev.innerHTML='';
    cards.slice(-12).reverse().forEach(c=>{
      const div = document.createElement('div');
      div.className='chip';
      div.textContent = c.q.slice(0,80);
      prev.appendChild(div);
    })
  }

  $('#parse').addEventListener('click',()=>{
    const raw = $('#bulk').value.trim();
    if(!raw) return;
    const lines = raw.split(/\n+/).map(x=>x.trim()).filter(Boolean);
    const newCards = [];
    let added = 0;
    for(const ln of lines){
      const [q,a] = ln.split(/\s*[|;]\s*/);
      if(q && a){ 
        if(!cards.find(c => c.q === q)){ // Evitar duplicados
          // Agrega en formato simple, sin opciones incorrectas
          newCards.push({q, a, w:1, inc: []}); 
          added++;
        }
      }
    }
    if(!newCards.length){ alert('No se encontraron nuevos pares "Pregunta | Respuesta" v√°lidos.'); return; }
    cards = cards.concat(newCards);
    save(LS_KEY,cards); $('#bulk').value=''; renderBank();
    alert(`¬°Se agregaron ${added} tarjetas nuevas! (Modo simple, sin opciones incorrectas)`);
  });

  $('#clear').addEventListener('click',()=>{
    if(confirm('¬øEst√°s seguro de que quer√©s borrar TODAS las tarjetas y estad√≠sticas? Esta acci√≥n no se puede deshacer.')){ 
      cards=[]; save(LS_KEY,cards); 
      stats={hits:0, miss:0, today:0, lastReset: new Date().toDateString()}; save(STATS_KEY, stats);
      sessions=[]; save(SESS_KEY, sessions);
      renderBank(); 
      renderLog();
      alert('Todo reseteado. Recarg√° la p√°gina para intentar la carga autom√°tica de archivos.');
    }
  });

  $('#importFile').addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f) return; const r=new FileReader();
    r.onload=()=>{ try{ 
      const newCards = JSON.parse(r.result);
      if (!Array.isArray(newCards)) throw new Error('El JSON debe ser un array');
      cards=newCards; 
      save(LS_KEY,cards); 
      renderBank(); 
      alert(`Banco de ${cards.length} preguntas cargado.`);
    }catch(err){alert('JSON inv√°lido. Error: ' + err.message)} };
    r.readAsText(f);
    e.target.value = null; 
  });
  
  // Borramos el listener del importador de distractores
  const importDistractors = $('#importDistractors');
  if (importDistractors) importDistractors.closest('label').style.display = 'none';


  // --- ENTRENAR (Flashcards) ---
  function pick(){
    if(!cards.length || (cards.length > 0 && cards[0].q === '¬°Datos no cargados!')){ 
        $('#qText').textContent='Cargando preguntas... Si esto persiste, us√° el bot√≥n "Cargar banco" en la pesta√±a Preguntas.'; 
        return; 
    }
    const weights = cards.map(c=>Math.max(1, 11 - (c.w||1))); 
    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum; let idx=0;
    for(let i=0;i<weights.length;i++){ r-=weights[i]; if(r<=0){ idx=i; break; } }
    current = idx;
    $('#qText').textContent = cards[idx].q;
    $('#aText').textContent = cards[idx].a;
    $('#aBox').classList.add('hidden');
  }

  $('#flashcard').addEventListener('click',(e)=>{
    if(e.target.closest('button')) return;
    $('#aBox').classList.toggle('hidden');
  });
  $('#skip').addEventListener('click',pick);
  $('#resetSRS').addEventListener('click',()=>{ 
    if(confirm('¬øReiniciar el progreso de todas las tarjetas? Volver√°n a aparecer m√°s seguido.')){
      cards.forEach(c=>c.w=1); save(LS_KEY,cards); alert('Pesos reiniciados'); 
      renderBank();
      pick();
    }
  });

  $('#good').addEventListener('click',()=>{
    if(current==null) return; 
    cards[current].w = Math.min(10,(cards[current].w||1)+1);
    stats.hits++; stats.today++; saveAll(); pick();
  });
  $('#again').addEventListener('click',()=>{
    if(current==null) return; 
    cards[current].w = Math.max(1,(cards[current].w||1)-1);
    stats.miss++; stats.today++; saveAll(); pick();
  });

  // --- L√ìGICA DE EXAMEN ACTUALIZADA ---
  let examState=null;
  $('#startExam').addEventListener('click',()=>{
    const optN = Math.max(2, parseInt($('#optCount').value||4,10));
    
    // Filtrar preguntas que tengan suficientes opciones incorrectas
    const qualifiedCards = cards.map((card, index) => ({ card, index }))
                                .filter(item => item.card.inc && item.card.inc.length >= (optN - 1));

    const n = Math.min(parseInt($('#examCount').value||20,10), qualifiedCards.length);

    if (n === 0 || qualifiedCards.length < n) {
      return alert(`No hay suficientes preguntas con opciones predefinidas. (Necesitas ${n} preguntas que tengan al menos ${optN - 1} opciones incorrectas cada una en el JSON).`);
    }

    const selectedQuestions = shuffle(qualifiedCards).slice(0, n);
    
    examState = selectedQuestions.map(item => {
        const { card, index } = item;
        const correct = card.a;
        // Tomar k-1 incorrectas al azar de la lista de la pregunta
        const incorrectOptions = shuffle(card.inc).slice(0, optN - 1);
        const options = shuffle([correct, ...incorrectOptions]);
        return { i: index, q: card.q, a: correct, options: options, pick: null };
    });
    
    renderExam();
  });
  
  function renderExam(){
    $('#examBox').classList.remove('hidden'); $('#examResult').classList.add('hidden');
    $('#examBox').innerHTML = examState.map((e,ix)=>{
      const opts = e.options.map((o,k)=>`<label class=\"opt\"><input type=\"radio\" name=\"q${ix}\" value=\"${escapeHtml(o)}\"> ${escapeHtml(o)}</label>`).join('');
      return `<div class=\"card\" style=\"margin:10px 0\">
        <div class=\"q\"><b>${ix+1}.</b> ${escapeHtml(e.q)}</div>
        <div style="margin-top:12px">${opts}</div>
      </div>`;
    }).join('') + `<div class=\"row\" style=\"justify-content:flex-end; padding:10px 0;\"><button class=\"btn\" id=\"finishExam\">Finalizar y Corregir</button></div>`;
    $('#finishExam').addEventListener('click', finishExam);
  }

  function finishExam(){
    examState.forEach((e,ix)=>{
      const sel = document.querySelector(`input[name=\"q${ix}\"]:checked`);
      e.pick = sel ? sel.value : null;
    });
    let ok=0; 
    examState.forEach(e=>{ 
      const isCorrect = smartCompare(e.pick, e.a);
      if(isCorrect) ok++; 
      
      // Actualizar pesos SRS
      const card = cards[e.i];
      if(isCorrect){
        card.w = Math.min(10,(card.w||1)+1); stats.hits++;
      } else {
        card.w = Math.max(1,(card.w||1)-1); stats.miss++;
      }
    });
    stats.today += examState.length;
    saveAll(); renderBank();

    const score = Math.round((ok/examState.length)*100);
    const review = examState.map((e,ix)=>{
      const corr = smartCompare(e.pick, e.a);
      return `<div class=\"card\" style=\"margin:8px 0; border: 1px solid ${corr?'var(--good)':'var(--bad)'};\">
        <div style="font-weight:bold;"><b>${ix+1}.</b> ${escapeHtml(e.q)}</div>
        <div class=\"muted\" style="margin-top:8px; padding: 4px 8px; border-radius:4px; background:${corr?'#193c2e':'#3c1919'}">Tu opci√≥n: ${escapeHtml(e.pick||'‚Äî')}</div>
        ${corr ? '' : `<div style="margin-top:4px; padding: 4px 8px; border-radius:4px; background:#193c2e;">Correcta: <span class=\"mono\">${escapeHtml(e.a)}</span></div>`}
      </div>`;
    }).join('');
    
    $('#examBox').classList.add('hidden');
    $('#examResult').classList.remove('hidden');
    $('#examResult').innerHTML = `<h3 style=\"margin:0 0 6px 0\">Resultado: ${score}%</h3>
      <p class=\"muted\">Aciertos ${ok}/${examState.length}</p>
      ${review}
      <div class=\"row\" style=\"justify-content:flex-end; margin-top:10px\">
        <button class=\"btn\" id=\"retryExam\">Otra tanda al azar</button>
      </div>`;
    $('#retryExam').addEventListener('click',()=>$('#startExam').click());
    sessions.push({ts:Date.now(), n:examState.length, score}); save(SESS_KEY,sessions); renderLog();
    window.scrollTo(0,0);
  }

  // --- L√ìGICA DE QUIZ R√ÅPIDO ACTUALIZADA ---
  let quickTimer=null, quickLeft=60, quickScore=0, quickQ=null;

  function endQuick(){ 
    $('#quickBox').innerHTML = `<b>¬°Tiempo!</b> Puntaje final: ${quickScore}.`; 
    $('#quickTimer').classList.add('hidden');
    $('#startQuick').classList.remove('hidden');
  }

  function renderQuickQuestion() {
    if (!quickQ) return;
    const opts = quickQ.options.map(o => 
      `<button class="btn opt quick-opt" data-answer="${escapeHtml(o)}">${escapeHtml(o)}</button>`
    ).join('');
    $('#quickBox').innerHTML = `
      <div class="q">${escapeHtml(quickQ.q)}</div>
      <div class="grid two" style="margin-top:12px">${opts}</div>`;
    
    $$('.quick-opt').forEach(btn => btn.addEventListener('click', handleQuickAnswer));
  }

  function handleQuickAnswer(e) {
    if (!quickQ || quickLeft <= 0) return;
    const picked = e.target.dataset.answer;
    
    $$('.quick-opt').forEach(btn => btn.disabled = true);

    if (smartCompare(picked, quickQ.a)) {
      quickScore++;
      $('#quickScore').textContent = quickScore;
      e.target.style.background = 'var(--good)';
      e.target.style.color = '#0b1020';
    } else {
      e.target.style.background = 'var(--bad)';
      e.target.style.color = '#0b1020';
      const correctBtn = $(`button[data-answer="${escapeHtml(quickQ.a)}"]`);
      if(correctBtn) {
        correctBtn.style.background = 'var(--good)';
        correctBtn.style.color = '#0b1020';
      }
    }
    
    setTimeout(nextQuick, 400); 
  }

  function nextQuick(){
    if (quickLeft <= 0) {
        if(quickTimer) clearInterval(quickTimer); 
        endQuick(); 
        return; 
    }
    
    // Filtrar preguntas que tengan suficientes opciones incorrectas (al menos 3)
    const qualifiedCards = cards.map((card, index) => ({ card, index }))
                                .filter(item => item.card.inc && item.card.inc.length >= 3);
    
    if(qualifiedCards.length < 4){
        endQuick();
        return alert("No hay suficientes preguntas con opciones para el Quiz R√°pido.");
    }
    
    const i = Math.floor(Math.random()*qualifiedCards.length);
    const { card, index } = qualifiedCards[i];
    
    const correct = card.a;
    const incorrectOptions = shuffle(card.inc).slice(0, 3); // 3 incorrectas
    const options = shuffle([correct, ...incorrectOptions]);
    
    quickQ = {q: card.q, a: correct, options: options};
    renderQuickQuestion();
  }
  
  function tickQuick(){ 
    const m=Math.floor(quickLeft/60).toString().padStart(2,'0'); 
    const r=(quickLeft%60).toString().padStart(2,'0'); 
    $('#quickTimer').textContent=`${m}:${r}`; 
  }
  
  $('#startQuick').addEventListener('click',()=>{
    const qualifiedCards = cards.filter(card => card.inc && card.inc.length >= 3);

    if(qualifiedCards.length < 4 || (cards.length > 0 && cards[0].q === '¬°Datos no cargados!')) {
      return alert('Carg√° al menos 4 preguntas con 3 opciones incorrectas cada una en el JSON.');
    }
    
    quickLeft=60; quickScore=0; $('#quickScore').textContent=quickScore; 
    $('#quickTimer').classList.remove('hidden');
    $('#startQuick').classList.add('hidden');
    $('#quickBox').innerHTML = ''; 
    
    clearInterval(quickTimer); 
    tickQuick(); 
    quickTimer=setInterval(()=>{ 
      quickLeft--; 
      tickQuick(); 
      if(quickLeft<=0){ 
        clearInterval(quickTimer); 
        quickLeft=0; 
        endQuick(); 
      } 
    }, 1000);
    
    nextQuick();
  });


  // --- ESTAD√çSTICAS ---
  function renderLog(){
    const lines = [
      `Tarjetas: ${cards.length}`,
      `Repasos Hoy: ${stats.today} | Total Aciertos: ${stats.hits} | Total Errores: ${stats.miss}`,
      '--- Historial de Ex√°menes ---',
      ...sessions.slice(-20).reverse().map(s=>{
        const d = new Date(s.ts); 
        const dd = d.toLocaleDateString()+ ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        return `‚Ä¢ ${dd} ‚Äì ${s.n} preg. ‚Äì ${s.score}%`;
      })
    ];
    $('#log').textContent = lines.join('\n');
  }

  $('#backup').addEventListener('click',()=>{
    const blob = {cards, stats, sessions}; // Ya no exportamos distPool
    downloadJSON('backup_rafa_cnv_completo.json', blob);
  });
  
  $('#restore').addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f) return; const r=new FileReader();
    r.onload=()=>{ try{ 
      const blob=JSON.parse(r.result); 
      if(blob.cards){cards=blob.cards;} 
      if(blob.stats){stats=blob.stats} 
      if(blob.sessions){sessions=blob.sessions}
      // Ya no importamos distPool
      save(LS_KEY, cards);
      save(STATS_KEY, stats);
      save(SESS_KEY, sessions);
      renderBank(); 
      renderLog(); 
      alert('Backup restaurado exitosamente.'); 
    }catch(err){alert('JSON inv√°lido')} };
    r.readAsText(f);
    e.target.value = null;
  });
  
  $('#resetExamStats').addEventListener('click',()=>{
    if(confirm('¬øBorrar todas las estad√≠sticas de ex√°menes? (Los contadores de Aciertos/Errores y las preguntas NO se borrar√°n).')){
      sessions = [];
      save(SESS_KEY, sessions);
      renderLog();
      alert('Estad√≠sticas de ex√°menes reseteadas.');
    }
  });

  // --- Utils ---
  function load(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def; }catch(_){ return def; } }
  function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); } catch(e){ console.warn("Error guardando en localStorage", e); }}
  function saveAll(){ save(LS_KEY,cards); save(STATS_KEY,stats); save(SESS_KEY,sessions); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
  function downloadJSON(name, obj){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)],{type:'application/json'})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
  function normalize(str){ return (str||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9 ]+/g,' ').replace(/\s+/g,' ').trim(); }
  function smartCompare(user, correct){
    // Ahora que las opciones son predefinidas, la comparaci√≥n debe ser exacta.
    return user === correct;
  }

});
</script>
</body>
</html>
